<p align="center">
<img height=70px src="docs/images/logo.png">
<img height=70px src="docs/images/Go-Logo_Blue.png">
</p>

# Filter

Filter is used to store and pass around a query condition to the repository layer. Typical use cases may be:
	1. Passing a complex filter from the controller all the way till the repository.
	2. Pass additional where conditions from the service to the repository layer, without having to create a new repository method for every new where condition
(somwhat like JPA and Critera).

This implementation uses the Visitor patten. Converter is a visitor while Command is an Acceptor. New converter can be defined based on the destination DBs to be supported. As of now, we have SQLconverter.

The requirements can be found here: https://confluence.kksharmadevdev.com/x/YVBeBw

The algorithmic approach can be found here: https://confluence.kksharmadevdev.com/x/lKjyBw

Lucidchart link for UML: https://lucid.app/lucidchart/invitations/accept/acd0fcad-ee1f-411c-8f48-cd41c3fff2cd

Lucidchart link for interaction diagram: https://lucid.app/lucidchart/invitations/accept/edd03b2c-744b-4277-8024-45d88a356707

Alternatively, the lucid charts are added to wiki here: https://confluence.kksharmadevdev.com/x/ajYuC


### Third-Party Libraties

None

### Internal Packages

```go
//Package command represents a structure made of property,
//operator and value.
//A Command is what a converter can work with to generate
//the Output.
package command

//Package converters comprises the various converters that can be used
//to convert a Command to a Filter which consists of
//a query and a value as generated by the converter.
package converters

//Package filter houses the logic to create filters. A filter will have 
// a query and values, which can be used to append to the where clause
// of a DB query.
package filter
```

### Types
```go

//Command - stores a command to be run in sql
type Command struct {
	property string
	operator string
	value    string
}

//SQLconverter : Converts command to corresponding SQL syntax
type SQLconverter struct {
}

//Filter : stores the output of command to query conversion
type Filter struct {
	query  string
	values []interface{}
	ShouldAnd bool
}
```

### Interfaces
```go
//converter : interface for a command to a specific query language converter
type converter interface {
	DoForCommandWithoutValue(Command) (*filter.Filter, error)
	DoForCommandWithoutProperty(Command, func(string) string) (*filter.Filter, error)
	DoForCommandWithValue(Command, func(string) string) (*filter.Filter, error)
	GetANDFilter() (*filter.Filter, error)
	GetORFilter() (*filter.Filter, error)
	GetLimitFilter(limit int) (*filter.Filter, error)
	GetOrderByFilter(field string, mapper func(string) string) (*filter.Filter, error)
}
```

**Whitelisted Fields**

```go
/*
This map holds a mapping of the fields in the input filter query param which can be queried upon, to their respective DB field names, for an entity.
Intent is to: 
  1. Not expose the databse field names directly.
  2. Limit the fields that can be queries upon.
*/
var fieldMapper = map[string]string{
	"summary": "summary",
	"status":  "status",
}
```

**Supported Operators**
```go
/* 
Patterns expected in the input filter query that map to a query language operator.
*/
const (
	// And : will map to a query language AND operator.
	And Op = "AND"
	// Or : will map to a query language OR operator.
	Or Op = "OR"
	// Gt : will map to a query language GreaterThan operator.
	Gt Op = ">"
	// Ge : will map to a query language GeaterThanEqualTo operator.
	Ge Op = ">="
	// Lt : will map to a query language LessThan operator.
	Lt Op = "<"
	// Le : will map to a query language LessThanEqualTo operator.
	Le Op = "<="
	// Lhs : will map to a query language Opening Parenthesis operator.
	LHS Op = "("
	// Rhs : will map to a query language Closing Parenthesis operator.
	RHS Op = ")"
	// Not : will map to a query language NOT operator.
	Not Op = "!="
	// Eq : will map to a query language EQUALS operator.
	Eq Op = "="
	// Like : will map to a query language LIKE operator.
	Like Op = ":"
	// IN : will map to a query language IN operator.
	In Op = "IN"
	// Limit : will map to a query language LIMIT clause.
	Limit Op = "LIMIT"
	// OrderBy : will map to a query language ORDER BY clause.
	OrderBy Op = "ORDER BY"
)
```

**Extend the Command and Converter**
```go
package command
//AddOperator : adds a mapping of operator from filter to Command
func AddOperator(key opKey, value Op)

package converters
//AddOperator : adds a mapping of operator from Command to SQL
func AddOperator(key command.Op, value op)
```

**Append Output to SQL Query**
```go
package converters
//AppendOutputToWhereClause : appends the output to SQL query where clause
func AppendFilterToWhereClause(query string, f filter.Filter, start int) string
```

**Using filter to pass extra conditions to the repository method**
```go

const (
	siteByPrimaryFlag = "primaryFlag"
	siteByActiveFlag  = "activeFlag"

	partnerID = "1234"
)

const (
	//a sql query used by a repo method
	getSitesByPartnerIDSQL = `SELECT id, name FROM sites WHERE partner_id = $1;`

	//expected query post appending the filter the to static query above
	expectedSQL = `SELECT id, name FROM sites WHERE partner_id = $1 AND primary_flag = $2 and active_flag = $3;`
)

//a dummy site entity
type site struct{}

//holds a map of whitelisted fields to db field names
var fieldMap map[string]string = map[string]string{
	"id":          "id",
	"name":        "name",
	"primaryFlag": "primary_flag",
	"activeFlag":  "active_flag",
}

//a repository interface to get sites
type SiteRepo interface {
	//will return a list of sites for the partner id, filtered by the filter f
	GetSites(partnerId string, f *filter.Filter) ([]site, error)

	//a method that will accept a field name and return the corresponding db column name
	FieldMapper() func(string) string
}

//a SQL specific implementation of repository
type SQLSiteRepo struct {
	db *sql.DB
}

//FieldMapper : returns the field mapper for the repository
func (r *SQLSiteRepo) FieldMapper() func(string) string {
	return func(key string) string {
		return fieldMap[key]
	}
}
```

**Observe how the same repo method can be used to give filtered results based on the filter passed in**
```go

//GetSites : returns a list of sites by partnerId, filtered by the filter f
func (r *SQLSiteRepo) GetSites(partnerID string, f *filter.Filter) ([]site, error) {

	//Appending the putput to the where clause of the query.
	query, vals := sqlcnv.AppendFilterToWhereClause(getSitesByPartnerIDSQL, f, []interface{}{partnerID})

	//print and see the query and vals
	fmt.Println(query)
	fmt.Println(vals)

	//prepared statment call with the query and vals.
	_, err := r.db.Query(query, vals...)

	return []site{}, err
}

func main() {

	//setting up a mock db.
	db, mock, err := sqlmock.New()
	if err != nil {
		fmt.Printf("\nError creating mock db: %v", err)
	}
	defer db.Close()

	//setting query expectations.
	mock.ExpectQuery(regexp.QuoteMeta(expectedSQL)).WithArgs(partnerID, true, true).WillReturnRows(nil)

	//Create the repo
	var siteRepo SiteRepo
	siteRepo = &SQLSiteRepo{db}

	//Get the desired converter, SQL in this case
	cnv := sqlcnv.GetConverter()

	//Get only the sites which are primary and active
	//Filter site records by company id
	primaryCmd := command.New(siteByPrimaryFlag, string(command.Eq), "")
	primaryFilter, err := cnv.DoForCommandWithValue(primaryCmd, siteRepo.FieldMapper())
	if err != nil {
		fmt.Printf("\nCommand: %+v | Failed to create filter with error:%v",
			primaryCmd, err)
		return
	}

	//Filter site records by company id
	activeCmd := command.New(siteByActiveFlag, string(command.Eq), "")
	activeFilter, err := cnv.DoForCommandWithValue(activeCmd, siteRepo.FieldMapper())
	if err != nil {
		fmt.Printf("\nCommand: %+v | Failed to create filter with error:%v",
			activeCmd, err)
		return
	}

	andFilter, _ := cnv.GetANDFilter()

	f := primaryFilter.CopyWithNewVals(true).AND(andFilter, activeFilter.CopyWithNewVals(true))

	siteRepo.GetSites(partnerID, &f)

	//asserting the expectation.
	if err = mock.ExpectationsWereMet(); err != nil {
		fmt.Printf("\nThere were unfulfilled expectations: %v", err)
	}
}

```